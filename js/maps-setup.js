/* global L:false document:false $:false */
// that first line stops your editor from complaining about these variables
// being undefined, but it will still get mad at you if you accidentlaly try to change
// their values (which you must not do!!)
// `L` is the global Leaflet API object, which must be defined before this
// script is loaded
// `document` is of course the HTML document
// $ is the jQuery object (actually we're not using it here at the moment)
// but just in case you would like to make use of it, it's available


///////////////////////////////////////////////
// VARS!! VARS!! VARS!! VARS!! VARS!! VARS!! //
///////////////////////////////////////////////

//////////////////////////
// Globally Scoped Vars //
//////////////////////////

// In order to access map data, we need some of these variables to
// be defined in global scope. In some cases we can assign values here;
// in others we'll wait till we run the initialization function
// we do this here to make sure we can access them
// whenever we need to -- they have 'global scope'

// map initialization variables
let projectMap, // this will hold the map once it's initialized
    myCenter = [ 39.9042, 116.4074 ], // [ 55.4907, -1.594], // *latitude*, then longitude
    myZoom = 4; // set your preferred zoom here. higher number is closer in.
                // I set the zoom wide to give access to context before zooming in


// I'm complicating things a bit with this next set of variables, which will help us
// to make multi-colored markers.
// color options are red, blue, green, orange, yellow, violet, grey, black
// to use one of the ones I haven't provided here, 
// just substitute the color name in the URL value (just before `.png`)
const greenURL = 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png',
      yellowURL = 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-yellow.png',
      greyURL = 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-grey.png';

// create new icon classes
// I've added this just in case you want very fine control over your marker placement
const myIconClass = L.Icon.extend({
    options: {
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
    }});
// create the new icon types -- cf. https://leafletjs.com/examples/custom-icons/ and
// also https://leafletjs.com/reference-1.5.0.html#icon
const gryfIcon = new myIconClass({iconUrl: yellowURL}),
      slythIcon = new myIconClass({iconUrl: greenURL}),
      mysteryIcon = new myIconClass({iconUrl: greyURL});


// storing colors in variables, to make it easier to change all the related features at once
// you should probably do this too. 
let gryfCol = 'green',
    slythCol = 'green',
    hogCol = 'Blue',
    meadeCol = 'rgb(40,40,120)',
    towerCol = 'blue';

///////////////////////////////////////////////////////////////////////
// CHANGE THESE VARIABLE NAMES AND THEIR VALUES TO SUIT YOUR PROJECT //
// It's easy to do this in VSCode: right-click on a variable name    //
// and choose "rename symbol"                                        //
///////////////////////////////////////////////////////////////////////



//////////////////////////////////////////////////////////
// DATA DATA DATA DATA                                  //
// DATA DATA DATA DATA                                  //
//////////////////////////////////////////////////////////


//////////////////////////////////
// MAP DATA PART 1: MARKER INFO //
//////////////////////////////////

///////////////////////////////
// YOU NEED TO CHANGE THESE! //
///////////////////////////////

// These are placeholder arrays; we use them to generate other JS variables
// that will be more useful to us later on
// but writing them this way keeps the code as D.R.Y. as possible
const Contention =
    {
        "type": "FeatureCollection",
        "description": "Contested Areas Relevant to PRC",
        "features": [
          {
            "type": "Feature",
            "properties": {myColor: 'lightblack', title: "Taiwan", description: "Under Kuomintang control/ Alternatively Kuomintang safehouse" },
            "geometry": {
              "type": "Polygon",
              "coordinates": [
                [
                  [
                    121.57470703125,
                    25.304303764403617
                  ],
                  [
                    121.025390625,
                    25.035838555635017
                  ],
                  [
                    120.201416015625,
                    23.785344805941214
                  ],
                  [
                    120.06958007812499,
                    23.120153621695614
                  ],
                  [
                    120.30029296875,
                    22.53285370752713
                  ],
                  [
                    120.58593749999999,
                    22.380555501421533
                  ],
                  [
                    120.750732421875,
                    21.790107059807873
                  ],
                  [
                    120.89355468749999,
                    22.024545601240337
                  ],
                  [
                    121.014404296875,
                    22.695120184965695
                  ],
                  [
                    121.22314453124999,
                    22.755920681486405
                  ],
                  [
                    121.453857421875,
                    23.29181053244191
                  ],
                  [
                    121.640625,
                    23.956136333969283
                  ],
                  [
                    121.66259765625001,
                    24.17682515045749
                  ],
                  [
                    121.871337890625,
                    24.607069137709683
                  ],
                  [
                    121.81640624999999,
                    24.86650252692691
                  ],
                  [
                    121.9921875,
                    25.005972656239187
                  ],
                  [
                    121.937255859375,
                    25.130365915065003
                  ],
                  [
                    121.59667968749999,
                    25.284437746983055
                  ],
                  [
                    121.57470703125,
                    25.304303764403617
                  ]
                ]
              ]
            }
          },
         {
                "type": "Feature",
                "properties": {myColor: 'black', width: 20, title: "38th Parallel", description: "Agreed upon division of Korea between U.S.S.R. and U.S. following Japan's unconditional surrender" },
                "geometry": {
                  "type": "LineString",
                  "coordinates": [
                    [
                      126.1285400390625,
                      37.67077737288316
                    ],
                    [
                      126.2713623046875,
                      37.814123701604466
                    ],
                    [
                      126.6888427734375,
                      37.844494798834575
                    ],
                    [
                      126.67785644531249,
                      37.95286091815649
                    ],
                    [
                      127.1282958984375,
                      38.31149091244452
                    ],
                    [
                      127.58422851562499,
                      38.3287297527893
                    ],
                    [
                      128.0181884765625,
                      38.28131307922966
                    ],
                    [
                      128.1939697265625,
                      38.35888785866677
                    ],
                    [
                      128.353271484375,
                      38.61257832462118
                    ]
                  ]
                }
              }
            ]
          }
        ;
    const Manchdata={
        "type": "FeatureCollection",
        "description": "Manchuria: Door to China",
      "features": [
          {
            "type": "Feature",
            "properties": {myColor: 'orange', title: "Historic Manchuria ", description: "Industrial Zone: Railways into southern China began here" },
            "geometry": {
              "type": "Polygon",
              "coordinates": [
                [
                  [
                    121.55273437499999,
                    53.225768435790194
                  ],
                  [
                    121.201171875,
                    52.53627304145948
                  ],
                  [
                    122.78320312499999,
                    52.26815737376817
                  ],
                  [
                    123.134765625,
                    51.34433866059924
                  ],
                  [
                    125.595703125,
                    51.72702815704774
                  ],
                  [
                    126.21093749999999,
                    50.90303283111257
                  ],
                  [
                    124.365234375,
                    48.28319289548349
                  ],
                  [
                    122.34374999999999,
                    47.338822694822
                  ],
                  [
                    123.22265625000001,
                    46.31658418182218
                  ],
                  [
                    121.640625,
                    46.01222384063236
                  ],
                  [
                    122.25585937500001,
                    44.465151013519616
                  ],
                  [
                    123.837890625,
                    43.13306116240612
                  ],
                  [
                    120.08056640625,
                    41.75492216766298
                  ],
                  [
                    119.46533203125,
                    42.342305278572816
                  ],
                  [
                    118.87207031250001,
                    40.84706035607122
                  ],
                  [
                    119.77294921874999,
                    39.977120098439634
                  ],
                  [
                    121.09130859375,
                    40.84706035607122
                  ],
                  [
                    121.77246093750001,
                    40.94671366508002
                  ],
                  [
                    122.29980468749999,
                    40.329795743702064
                  ],
                  [
                    121.33300781249999,
                    39.53793974517628
                  ],
                  [
                    121.83837890625,
                    39.33429742980725
                  ],
                  [
                    121.13525390625,
                    38.8225909761771
                  ],
                  [
                    121.9482421875,
                    39.04478604850143
                  ],
                  [
                    123.20068359374999,
                    39.80853604144591
                  ],
                  [
                    124.34326171874999,
                    39.8928799002948
                  ],
                  [
                    126.16699218749999,
                    41.07935114946899
                  ],
                  [
                    126.67236328125,
                    41.75492216766298
                  ],
                  [
                    127.001953125,
                    41.77131167976407
                  ],
                  [
                    127.24365234374999,
                    41.47566020027821
                  ],
                  [
                    128.14453125,
                    41.376808565702355
                  ],
                  [
                    128.32031249999997,
                    41.64007838467894
                  ],
                  [
                    128.03466796875,
                    42.06560675405716
                  ],
                  [
                    128.91357421875,
                    42.06560675405716
                  ],
                  [
                    129.35302734375,
                    42.439674178149424
                  ],
                  [
                    129.66064453124997,
                    42.439674178149424
                  ],
                  [
                    129.8583984375,
                    43.068887774169625
                  ],
                  [
                    130.58349609375,
                    42.4234565179383
                  ],
                  [
                    130.4296875,
                    42.71473218539458
                  ],
                  [
                    131.15478515625,
                    42.924251753870685
                  ],
                  [
                    131.220703125,
                    43.91372326852401
                  ],
                  [
                    131.02294921875,
                    44.85586880735725
                  ],
                  [
                    131.8798828125,
                    45.3521452458518
                  ],
                  [
                    132.95654296875,
                    45.10454630976873
                  ],
                  [
                    134.75830078125,
                    47.73932336136857
                  ],
                  [
                    134.71435546875,
                    48.37084770238366
                  ],
                  [
                    131.02294921875,
                    47.65058757118734
                  ],
                  [
                    130.58349609375,
                    48.879167148960214
                  ],
                  [
                    129.52880859375,
                    49.410973199695846
                  ],
                  [
                    128.32031249999997,
                    49.5822260446217
                  ],
                  [
                    127.83691406249999,
                    49.5822260446217
                  ],
                  [
                    127.529296875,
                    49.908787000867136
                  ],
                  [
                    127.39746093749999,
                    50.30337575356313
                  ],
                  [
                    126.87011718749999,
                    51.12421275782688
                  ],
                  [
                    126.43066406249999,
                    52.05249047600099
                  ],
                  [
                    126.16699218749999,
                    52.576349937498875
                  ],
                  [
                    125.41992187499999,
                    53.1335898292448
                  ],
                  [
                    124.95849609375,
                    53.212612189941574
                  ],
                  [
                    124.82666015624999,
                    53.09402405506325
                  ],
                  [
                    123.74999999999999,
                    53.50111704294316
                  ],
                  [
                    122.6953125,
                    53.474969999548556
                  ],
                  [
                    122.25585937500001,
                    53.474969999548556
                  ],
                  [
                    121.57470703125,
                    53.370220573956786
                  ],
                  [
                    121.53076171875,
                    53.291489065300226
                  ],
                  [
                    121.55273437499999,
                    53.225768435790194
                  ]
                ]
              ]
            }
          },
          {
            "type": "Feature",
                "properties": {myColor: 'light', title: "Japanese Occupation 1937-1945", description: "Approximate area occupied by Japanese forces, the invasion followed the railroads with the Japanese using them to resupply their army" },
                "geometry": {
                  "type": "Polygon",
                  "coordinates": [
                    [
                        [
                            121.640625,
                            53.25206880589411
                          ],
                          [
                            121.81640624999999,
                            53.09402405506325
                          ],
                          [
                            121.28906250000001,
                            52.5897007687178
                          ],
                          [
                            122.03613281249999,
                            52.482780222078226
                          ],
                          [
                            123.0908203125,
                            51.26191485308451
                          ],
                          [
                            125.20019531249999,
                            51.67255514839674
                          ],
                          [
                            126.2548828125,
                            50.736455137010665
                          ],
                          [
                            125.15625000000001,
                            49.009050809382046
                          ],
                          [
                            124.4091796875,
                            48.04870994288686
                          ],
                          [
                            124.1455078125,
                            48.42920055556841
                          ],
                          [
                            122.3876953125,
                            47.368594345213374
                          ],
                          [
                            122.958984375,
                            46.830133640447386
                          ],
                          [
                            123.48632812499999,
                            46.98025235521883
                          ],
                          [
                            123.57421875,
                            46.73986059969267
                          ],
                          [
                            123.0908203125,
                            46.5286346952717
                          ],
                          [
                            123.04687499999999,
                            46.195042108660154
                          ],
                          [
                            122.08007812499999,
                            45.89000815866184
                          ],
                          [
                            121.6845703125,
                            45.767522962149876
                          ],
                          [
                            122.1240234375,
                            45.182036837015886
                          ],
                          [
                            122.34374999999999,
                            44.11914151643737
                          ],
                          [
                            123.0908203125,
                            44.465151013519616
                          ],
                          [
                            123.31054687499999,
                            43.45291889355465
                          ],
                          [
                            123.662109375,
                            43.32517767999296
                          ],
                          [
                            123.22265625000001,
                            42.74701217318067
                          ],
                          [
                            122.1240234375,
                            42.779275360241904
                          ],
                          [
                            121.5087890625,
                            42.35854391749705
                          ],
                          [
                            120.58593749999999,
                            42.06560675405716
                          ],
                          [
                            120.1904296875,
                            41.77131167976407
                          ],
                          [
                            119.66308593749999,
                            42.22851735620852
                          ],
                          [
                            119.39941406249999,
                            42.22851735620852
                          ],
                          [
                            119.44335937499999,
                            41.541477666790286
                          ],
                          [
                            119.00390625,
                            41.343824581185686
                          ],
                          [
                            118.564453125,
                            41.343824581185686
                          ],
                          [
                            118.21289062499999,
                            41.672911819602085
                          ],
                          [
                            118.16894531249999,
                            42.032974332441405
                          ],
                          [
                            117.90527343750001,
                            42.48830197960227
                          ],
                          [
                            117.42187500000001,
                            42.48830197960227
                          ],
                          [
                            116.98242187499999,
                            42.293564192170095
                          ],
                          [
                            116.89453125,
                            41.96765920367816
                          ],
                          [
                            116.5869140625,
                            41.902277040963696
                          ],
                          [
                            116.103515625,
                            41.80407814427234
                          ],
                          [
                            115.8837890625,
                            41.902277040963696
                          ],
                          [
                            115.48828125000001,
                            41.73852846935917
                          ],
                          [
                            115.1806640625,
                            41.57436130598913
                          ],
                          [
                            114.873046875,
                            41.902277040963696
                          ],
                          [
                            114.6533203125,
                            42.09822241118974
                          ],
                          [
                            114.3896484375,
                            41.86956082699455
                          ],
                          [
                            114.12597656249999,
                            41.672911819602085
                          ],
                          [
                            113.818359375,
                            41.47566020027821
                          ],
                          [
                            113.90625,
                            40.97989806962013
                          ],
                          [
                            114.12597656249999,
                            40.54720023441049
                          ],
                          [
                            112.763671875,
                            40.245991504199026
                          ],
                          [
                            113.02734374999999,
                            39.740986355883564
                          ],
                          [
                            113.9501953125,
                            40.01078714046552
                          ],
                          [
                            114.60937499999999,
                            39.53793974517628
                          ],
                          [
                            113.818359375,
                            38.95940879245423
                          ],
                          [
                            113.818359375,
                            38.20365531807149
                          ],
                          [
                            114.169921875,
                            37.78808138412046
                          ],
                          [
                            113.73046875,
                            37.020098201368114
                          ],
                          [
                            113.818359375,
                            36.13787471840729
                          ],
                          [
                            113.15917968749999,
                            35.17380831799959
                          ],
                          [
                            110.74218749999999,
                            34.59704151614417
                          ],
                          [
                            113.818359375,
                            34.19817309627726
                          ],
                          [
                            115.53222656249999,
                            33.61461929233378
                          ],
                          [
                            115.04882812499999,
                            33.211116472416855
                          ],
                          [
                            115.1806640625,
                            32.65787573695528
                          ],
                          [
                            115.7080078125,
                            32.47269502206151
                          ],
                          [
                            115.927734375,
                            32.175612478499325
                          ],
                          [
                            115.6640625,
                            31.653381399664
                          ],
                          [
                            115.26855468749999,
                            31.42866311735861
                          ],
                          [
                            113.02734374999999,
                            30.86451022625836
                          ],
                          [
                            111.8408203125,
                            30.486550842588485
                          ],
                          [
                            111.4013671875,
                            29.305561325527698
                          ],
                          [
                            111.4013671875,
                            28.033197847676377
                          ],
                          [
                            112.24731445312499,
                            27.31321389856826
                          ],
                          [
                            112.225341796875,
                            26.765230565697482
                          ],
                          [
                            111.258544921875,
                            26.61799672211676
                          ],
                          [
                            111.192626953125,
                            25.740529092773226
                          ],
                          [
                            110.830078125,
                            24.73685348477069
                          ],
                          [
                            111.082763671875,
                            23.865745352647956
                          ],
                          [
                            109.16015624999999,
                            24.086589258228027
                          ],
                          [
                            107.99560546875,
                            22.998851594142913
                          ],
                          [106.69921875,
                            22.63429269379353
                          ],
                          [106.8310546875,21.90227796666864],
                          [107.6220703125,21.616579336740603],
                          [108.5888671875,21.739091217718574],
                          [109.248046875,21.49396356306447],
                          [111.4892578125,21.53484700204879],
                          [113.48876953125,22.085639901650328],
                          [114.873046875,22.755920681486405],
                          [113.97216796875,24.647017162630366],
                          [113.26904296874999,26.09625490696853],
                          [113.51074218749999,27.449790329784214],
                          [114.6533203125,29.34387539941801],
                          [116.01562499999999,28.091366281406945],
                          [117.6416015625,29.32472016151103],
                          [118.14697265625,30.600093873550072],
                          [119.13574218749999,29.11377539511439],
                          [120.62988281249999,27.72243591897343],
                          [121.9482421875,29.32472016151103],
                          [121.9482421875,29.916852233070173],
                          [120.4541015625,30.29701788337205],
                          [121.9482421875,30.977609093348686],
                          [121.46484375,32.287132632616384],
                          [120.10253906249999,34.23451236236987],
                          [119.17968749999999,34.813803317113155],
                          [120.4541015625,36.1733569352216],
                          [122.34374999999999,37.020098201368114],
                          [121.9921875,37.579412513438385],
                          [120.89355468749999,37.75334401310656],
                          [119.17968749999999,37.020098201368114],
                          [118.87207031250001,37.996162679728116],
                          [117.6416015625,38.61687046392973],
                          [118.16894531249999,39.13006024213511],
                          [119.2236328125,39.40224434029275],
                          [121.1572265625,40.78054143186033],
                          [121.9921875,40.74725696280421],
                          [122.1240234375,40.1452892956766],
                          [121.5087890625,39.70718665682654],
                          [121.37695312499999,38.89103282648846],
                          [124.27734374999999,39.842286020743394],
                          [124.98046874999999,40.54720023441049],
                          [126.0791015625,40.97989806962013],
                          [126.9580078125,41.86956082699455],
                          [127.35351562499999,41.343824581185686],
                          [128.232421875,41.343824581185686],
                          [128.14453125,41.96765920367816],
                          [129.19921875,42.16340342422401],
                          [129.990234375,42.97250158602597],
                          [130.4736328125,42.68243539838623],
                          [131.30859375,43.48481212891603],
                          [131.0009765625,44.87144275016589],
                          [131.8798828125,45.30580259943578],
                          [133.0224609375,45.058001435398275],
                          [134.82421875,48.37084770238366],
                          [131.1328125,47.724544549099676],
                          [130.4736328125,48.86471476180277],
                          [127.61718749999999,50.261253827584724],
                          [125.46386718749999,53.09402405506325],
                          [123.662109375,53.51418452077113],
                          [122.56347656249999,53.4357192066942],
                          [121.77246093750001,53.35710874569601],
                          [121.640625,53.25206880589411]
                    ]
                  ]
                }
              }
            ]
          }
    ;


let gryfMarkers = processJSONLayer(Manchdata)

let slythMarkers = processJSONLayer(Contention);



//////////////////////////////
// MAP DATA PART 2: GEOJSON //
//////////////////////////////

// With this powerful feature you can add arbitrary
// data layers to your map.  It's cool. Learn more at:
// https://leafletjs.com/examples/geojson/
// but essentially: we can add all kinds of features here, including polygons and other shapes
// you can create geoJSON layers here: http://geojson.io/
// and learn more about the format here: https://en.wikipedia.org/wiki/GeoJSON
// to set the line and fill color, you will need to set the `myColor` property as below. 
const townsData={
    "type": "FeatureCollection",
    "description": "U.S. Military Presence",
  "features": [
    {
      "type": "Feature",
        "properties": {myColor: hogCol, title: "South Korea", description: "U.S. Backed Capitalist South Korea" },
      "geometry": {
        "type": "Polygon",
        "coordinates":[
            [
              [
                126.69433593749999,
                37.91820111976663
              ],
              [
                126.474609375,
                37.622933594900864
              ],
              [
                126.88110351562499,
                36.86204269508728
              ],
              [
                126.485595703125,
                37.02886944696474
              ],
              [
                126.18896484375,
                36.80048816579081
              ],
              [
                126.79321289062501,
                35.90684930677121
              ],
              [
                125.92529296875,
                34.71452466170392
              ],
              [
                126.03515625,
                34.334364487026306
              ],
              [
                126.71630859375,
                34.30714385628804
              ],
              [
                128.73779296875,
                34.82282272723702
              ],
              [
                129.605712890625,
                36.075742215627
              ],
              [
                128.3642578125,
                38.60828592850559
              ],
              [
                128.056640625,
                38.212288054388175
              ],
              [
                127.66113281249999,
                38.28131307922966
              ],
              [
                127.16674804687501,
                38.25543637637947
              ],
              [
                126.925048828125,
                38.09133660751176
              ],
              [
                126.69433593749999,
                37.91820111976663
              ]
            ]
          ]
      }
    },    
    {
      "type": "Feature",
        "properties": {myColor: hogCol, title: "Taiwan Straight", description: "U.S. Navy's Seventh Fleet"},
      "geometry": {
        "type": "Polygon",
        "coordinates": [
            [
              [
                121.212158203125,
                25.720735134412106
              ],
              [
                119.73999023437499,
                24.946219074360084
              ],
              [
                119.02587890624999,
                23.725011735951796
              ],
              [
                118.88305664062499,
                22.370396344320053
              ],
              [
                119.014892578125,
                22.40087159030595
              ],
              [
                119.190673828125,
                23.725011735951796
              ],
              [
                119.84985351562499,
                24.836595553891183
              ],
              [
                121.26708984374999,
                25.651430347039724
              ],
              [
                121.212158203125,
                25.720735134412106
              ]
            ]
          ]
      }
    },
    
  ]
}

let towns = processJSONLayer(townsData)

////////////////////////////////////////////////////////
// MAP DATA PART 3: DIRECT CREATION OF SHAPE OVERLAYS //
////////////////////////////////////////////////////////


// Hogwarts Buildings Objects and LayerGroup
// API docs: https://leafletjs.com/reference-1.5.0.html#polygon
//  (keep scrolling for docs on rectangles and circles)
let Beijing = L.circle([39.9042, 116.4074], {
    color: 'white',
    opacity: 0.8,
    weight: 6,
    fillColor: 'white',
    fillOpacity: 0.35,
    title: 'Beijing',
    windowContent: `<h3>Beijing</h3><p>People's Republic of China Capital</p3>`
});

let Seoul = L.circle([37.5665,
    126.9780], {
    color: 'white',
    opacity: 0.8,
    weight: 6,
    fillColor: 'white',
    fillOpacity: 0.35,
    title: 'Seoul',
    windowContent: `<h3>Seoul</h3><p>Becomes capital of South Korea</p3>`
});

let Pyongyang = L.circle([39.0392, 125.7625], {
    color: 'white',
    opacity: 0.8,
    weight: 6,
    fillColor: 'white',
    fillOpacity: 0.35,
    radius: 40,
    title: 'Pyongyang',
    windowContent: `<h3>Pyongyang</h3><p>SceneBecomes capital of North Korea</p>`
});

let houses = processManualLayers([Beijing, Seoul, Pyongyang],
                                 {description: 'Capitals'});




// Polyline Objects and Layer Group ("paths")
let vanishingPath = L.polyline([[37.47485808497102,127.001953125],
                                [39.232253141714885,125.68359374999999],
                                [ 41.80407814427234, 123.134765625],
                                [41.27780646738183, 119.091796875],
                                [39.80853604144591, 116.3671875]], {
                                    color: slythCol,
                                    weight: 6,
                                    title: 'Potential Invasion',
                                    windowContent: `<h3>Mao's Fear</h3><p>Mao feared U.S. invasion similar to Japan's through Manchuria, should the U.S. come to occupy North Korea </p>`})


let tunnelPath = L.polyline([[26.941659545381516,119.17968749999999],
                                [25.48295117535531,118.7841796875],[
                                    23.36242859340884, 120.498046875],[
                                    24.126701958681668, 117.20214843749999],
                                    [23.36242859340884, 115.7080078125]], {
                                    color: gryfCol,
                                    weight: 6,
                                    title: 'Return of the KMT',
                                    windowContent: `<h3>Mao Fear #2</h3><p>If the U.S. chose to, they could deploy KMT forces to Southern China </p>`})


let paths = processManualLayers([vanishingPath, tunnelPath], {description: 'Paths'})


////////////////////////////////////////////////
// array of all the layers!!!!!!!
// these layers will be added to the map
// you should change these variable names
// to align with the variables you've defiend above
let allLayers = [gryfMarkers, slythMarkers, towns, houses, paths];


///////////////////////////////////////
// END DATA!!  END DATA!! END DATA!! //
///////////////////////////////////////

//////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////


/////////////////////////////////////////////
// FUNCTIONS FUNCTIONS FUNCTIONS FUNCTIONS //
/////////////////////////////////////////////


/**
 * create a Leaflet map inside an element, add base layer and return the map as a return value
 * @param {HTMLElement|string} element: can be either a full HTMLElement or the ID attribute
 * of a DOM node
 * @returns {Object} a Leaflet map object 
 */
function createMap (element) {
    const map = L.map(element, {renderer:L.canvas(), preferCanvas: true}).setView(myCenter, myZoom);
    // now we add the base layer
    // you can change this if you want!
    // if your tiles seem to load very slowly, you may want to generate your own accessToken
    // and insert the value in `accessToken`, below. 
    // see: https://docs.mapbox.com/help/how-mapbox-works/access-tokens/#creating-and-managing-access-tokens

    // to change the tile layer, change the `id` attribute below.
    // some valid options include:
    // mapbox/streets-v11
    // mapbox/outdoors-v11
    // mapbox/light-v10
    // mapbox/dark-v10
    // mapbox/satellite-v9
    // mapbox/satellite-streets-v11

    // I've also created a simple style using studio.mapbox.com, which you can access
    // with this id:
    // titaniumbones/ckhnvk5pl18o71apeq8q1duhc
    // You can modify it yourself using this link: 
    // https://api.mapbox.com/styles/v1/titaniumbones/ckhnvk5pl18o71apeq8q1duhc.html?fresh=true&title=copy&access_token=pk.eyJ1IjoidGl0YW5pdW1ib25lcyIsImEiOiJjazF0bTdlNXQwM3gxM2hwbXY0bWtiamM3In0.FFPm7UIuj_b15xnd7wOQig
    // Here's a green and blue one for good measure:
    // https://api.mapbox.com/styles/v1/titaniumbones/ckhnvqfda18qu19o2oool6h2c.html?fresh=true&title=copy&access_token=pk.eyJ1IjoidGl0YW5pdW1ib25lcyIsImEiOiJjazF0bTdlNXQwM3gxM2hwbXY0bWtiamM3In0.FFPm7UIuj_b15xnd7wOQig
    L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}', {
	attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
	maxZoom: 18,
        id: 'mapbox/outdoors-v11',
        // id: 'titaniumbones/ckhnvk5pl18o71apeq8q1duhc',
        tileSize: 512,
        zoomOffset: -1,
	accessToken: 'pk.eyJ1IjoidGl0YW5pdW1ib25lcyIsImEiOiJjazF0bTdlNXQwM3gxM2hwbXY0bWtiamM3In0.FFPm7UIuj_b15xnd7wOQig'
    })
        .addTo(map);
    return map
}


/**
 * Add Markers to a "layerGroup" and return the populated object
 * @param {Array.<Object>} markerInfo
 * @param {string} markerInfo[].title
 * @param {Array|Object} markerInfo[].position
 * @param {Object} layerGroup
 * @returns {Object} the modified layerGroup object 
 */
function processMarkerLayer (markerInfo, options) {
    let layerGroup = L.layerGroup([], options);
    // iterate over the marker info array, adding to the main marker layer but
    // *also* to another layer if the icon property is set. 
    for (const m of markerInfo) {
        // define a Leaflet marker object for each marker
        // we pass two parameters: a position (2-value array of lat & lng vals)
        // and an object containing marker propertie
        let marker =  L.marker (m.position, {
            // We set the icon 
            icon:   m.icon || layerGroup.options.defaultIcon || L.Icon(),
            title: m.title,
            description: m.description,
            windowContent: m.windowContent //this is obsolete
        });
        let t = assembleTexts(marker);
        marker.bindPopup(t.popup);
        // this seems to be unnecessary on modern browsers for some reason
        //marker.bindTooltip(t.tooltip);
        layerGroup.addLayer(marker);
    }
    return layerGroup;
}

/**
 * create a geoJSON layer and return the geoJSON layer object.
 * If the featureGroup has the non-standard property
 * 'description' it will be explicitly set on the returned object as well.
 * If an individual feature has the property feature.properties.title,
 * then the options.title property will be set on the resultant layer
 * for compatibility with marker layers.
 * The custom property `feature.properties.myColor` will also be used to set line and
 * fill colors.
 * 
 * @param {GeoJSON} jsonData
 * @returns {Object} the newly-created geoJSON layer 
 */
function processJSONLayer (jsonData) {
    return L.geoJSON(jsonData, {
        // the 'style' option is a *function* that modifies some
        // feature properties.  
        // cf https://leafletjs.com/reference-1.5.0.html#geojson-style
        style: function(feature) {
            let c = feature.properties.myColor;
            return {color: c, weight: 3, fillColor: c, fillOpacity: 0.5};
        },
        onEachFeature: function (feature, layer) {
            layer.options.description = '';
            if (feature.properties ) {
                if (feature.properties.title) {
                    layer.options.title = feature.properties.title;
                }
                if (feature.properties.description) {
                    layer.options.description = feature.properties.description;
                }
            }
            let t = assembleTexts(layer);
            layer.bindPopup(t.popup);
            layer.bindTooltip(t.tooltip, {sticky: true});
        },
        description: jsonData.description || "GeoJSON Objects"
    });
}

/**
 * create a layerGroup from an array of individual Layer objects.
 * If the non-standard options `windowContent`, `title`, and/or `description` have been
 * set, they will be used to create a popup window and tooltip now, and
 * to generate legend text in `addLayerToLegendHTML` later on.
 * The `options` parameter should include a `description` property,
 * (NOTE: this is *separate* from the description of the individual layers!!)
 * which will also be used by `addLayerToLegendHTML` and in the layers
 * control box. 
 * @param {} layerArray
 * @param {} options
 * @returns {} 
 */
function processManualLayers (layerArray, options = {description: 'Unnamed Layer'}) {
    for (const l of layerArray) {
        let t = assembleTexts(l);
        l.bindPopup(t.popup);
        l.bindTooltip(t.tooltip, {sticky: true});
    }
    return L.layerGroup(layerArray, options)
}


function assembleTexts (feature) {
    let opts = feature.options,
        tooltip = 'Untitled Tooltip',
        popup = '<h2>Untitled</h2>',
        legend = 'Untitled';
    
    if (opts.title) {
        popup = `<h2>${opts.title}</h2>` + (opts.description || '');
        tooltip = opts.title;
        legend = opts.title;
    }
    if (opts.windowContent) {
        popup = opts.windowContent;
    }
    return {tooltip: tooltip, popup: popup, legend: legend};
}
/**
 * For every element of `layerGroup`, add an entry to the innerHTML of
 * the element matched by `querySelector`, consisting of a div whose
 * `onclick` attribute is a call to `locateMapFeature` which navigates to, and
 * opens the popup window of, that feature.  The link text will be one of `options.infoHTML`,
 * `options.title`, or 'no title', in that order.
 * @param {Array} layerGroup
 * @param {string} querySelector
 * @returns {string} innerHTML content of the legend element 
 */
function addLayerToLegendHTML (layerGroup, el) {
    let output = `<div class="legend-content-group-wrapper"><h2>${layerGroup.options.description}</h2>`;
    for (let l in layerGroup._layers) {
        // this is hideously ugly! very roundabout way
        // to access anonymous marker from outside the map
        let current = layerGroup._layers[l];
        let info = assembleTexts(current).legend;
        output +=  `
<div class="pointer" onclick="locateMapFeature(projectMap._layers[${layerGroup._leaflet_id}]._layers[${l}])"> 
    ${info} 
</div>`;
    }
    output += '</div>'
    el.innerHTML += output;
    return el.innerHTML
}

/* a function that will run when the page loads.  It creates the map
   and adds the existing layers to it. You probably don't need to change this function; 
   instead, change data and variable names above, or change some of the helper functions that
   precede this function.
 */
async function initializeMap() {

    // this one line creates the actual map
    // it calls a simple 2-line function defined above
    projectMap = createMap('map_canvas');
    // set the legend location
    let legendEl = document.querySelector('#map_legend');

    let layerListObject = {};
    // add markers to map and to legend, then add a toggle switch to layers control panel
    for (let l of allLayers) {
        l.addTo(projectMap);
        addLayerToLegendHTML(l, legendEl);
        layerListObject[l.options.description] = l;
    }

   // add a layers control to the map, using the layer list object
    // assigned above
    L.control.layers(null, layerListObject).addTo(projectMap);

    // You'll want to comment this out before handing in, but it makes life a bit easier.
    // while you're developing
    coordHelp();
}

/**
 * pan to object if it's a marker; otherwise use the `fitBounds` method on the feature
 * Then open the marker popup.
 * @param {Object} marker
 */
function locateMapFeature (marker) {
    marker.getLatLng ? projectMap.flyTo(marker.getLatLng(), 16, {animate: true, duration: 1.5}) : projectMap.fitBounds(marker.getBounds(), {animate: true, duration: 1.5}); 
    marker.openPopup();
}

function coordHelp () {
    projectMap.on('click', function(e) {
        console.log("Lat, Lon : [ " + e.latlng.lat + ", " + e.latlng.lng + " ]")
    });
}

function resetMap (map) {
    map.setView(myCenter, myZoom, {animate: true, duration: 1.5}).closePopups()
}
